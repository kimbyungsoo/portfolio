"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getGloballyUniqueId = getGloballyUniqueId;
exports.transformResult = transformResult;
exports.transformQueryConstraint = transformQueryConstraint;
exports.base64 = base64;
exports.parseID = parseID;
exports.connectionResultsArray = connectionResultsArray;
exports.runFind = runFind;
exports.runGet = runGet;
exports.resolvePointer = resolvePointer;
exports.containsOnlyIdFields = containsOnlyIdFields;
exports.handleFileUpload = handleFileUpload;
Object.defineProperty(exports, "rest", {
  enumerable: true,
  get: function () {
    return _rest.default;
  }
});

var _rest = _interopRequireDefault(require("../rest"));

var _ACL = require("./types/ACL");

var _Config = require("../Config");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function getGloballyUniqueId(className, objectId) {
  return base64(`${className}::${objectId}`);
}

function transformResult(className, result) {
  if (Array.isArray(result)) {
    return result.map(res => transformResult(className, res));
  }

  if (result.objectId) {
    // Make a unique identifier for relay
    result.id = getGloballyUniqueId(className, result.objectId);
  }

  if (result.ACL) {
    result.ACL = (0, _ACL.toGraphQLACL)(result.ACL);
  }

  return Object.assign({
    className
  }, result);
}

function toGraphQLResult(className) {
  return restResult => {
    const results = restResult.results;

    if (results.length == 0) {
      return [];
    }

    return transformResult(className, results);
  };
}

function transformQueryConstraint(key, value) {
  if (key === 'nearSphere') {
    value = {
      latitude: value.point.latitude,
      longitude: value.point.longitude
    };
  }

  return {
    key: `$${key}`,
    value
  };
}

function transformQuery(query) {
  Object.keys(query).forEach(queryKey => {
    Object.keys(query[queryKey]).forEach(constraintKey => {
      const constraint = query[queryKey][constraintKey];
      delete query[queryKey][constraintKey];
      const {
        key,
        value
      } = transformQueryConstraint(constraintKey, constraint);
      query[queryKey][key] = value;
    });
  });
  return query;
}

function base64(string) {
  return new Buffer(string).toString('base64');
}

function parseID(base64String) {
  // Get the selections
  const components = new Buffer(base64String, 'base64').toString('utf8').split('::');

  if (components.length != 2) {
    throw new Error('Invalid ID');
  }

  return {
    className: components[0],
    objectId: components[1]
  };
}

function connectionResultsArray(results, args, defaultPageSize) {
  const pageSize = args.first || args.last || defaultPageSize;
  return {
    nodes: () => results,
    edges: () => results.map(node => {
      return {
        cursor: base64(node.createdAt),
        node
      };
    }),
    pageInfo: () => {
      const hasPreviousPage = () => {
        if (args.last) {
          return results.length === pageSize;
        }

        if (args.after) {
          return true;
        }

        return false;
      };

      const hasNextPage = () => {
        if (args.first) {
          return results.length === pageSize;
        }

        if (args.before) {
          return true;
        }

        return false;
      };

      return {
        hasNextPage,
        hasPreviousPage
      };
    }
  };
}

function parseArguments(args) {
  const query = {};
  const options = {};

  if (Object.prototype.hasOwnProperty.call(args, 'first')) {
    options.limit = args.first;
    options.order = 'createdAt';
  }

  if (Object.prototype.hasOwnProperty.call(args, 'last')) {
    options.limit = args.last;
    options.order = '-createdAt';
  }

  if (Object.prototype.hasOwnProperty.call(args, 'after')) {
    query.createdAt = {
      $gt: new Date(new Buffer(args.after, 'base64').toString('utf8'))
    };
  }

  if (Object.prototype.hasOwnProperty.call(args, 'before')) {
    query.createdAt = {
      $lt: new Date(new Buffer(args.before, 'base64').toString('utf8'))
    };
  }

  if (Object.prototype.hasOwnProperty.call(args, 'redirectClassNameForKey')) {
    options.redirectClassNameForKey = args.redirectClassNameForKey;
  }

  return {
    options,
    queryAdditions: query
  };
}

// Runs a find against the rest API
function runFind(context, info, className, args, schema, restQuery) {
  const query = {};

  if (args.where) {
    Object.assign(query, args.where);
  }

  transformQuery(query, schema);

  if (restQuery) {
    Object.assign(query, restQuery);
  }

  const {
    options,
    queryAdditions
  } = parseArguments(args);
  Object.assign(query, queryAdditions);
  return _rest.default.find(context.config, context.auth, className, query, options).then(toGraphQLResult(className));
} // runs a get against the rest API


function runGet(context, info, className, objectId) {
  return _rest.default.get(context.config, context.auth, className, objectId, {}).then(toGraphQLResult(className)).then(results => results[0]);
}

function resolvePointer(targetClass, object, schema, context, info) {
  const selections = info.fieldNodes[0].selectionSet.selections.map(field => {
    return field.name.value;
  });

  if (containsOnlyIdFields(selections)) {
    return transformResult(targetClass, object, schema, {
      context,
      info
    });
  }

  return runGet(context, info, object.className, object.objectId, schema);
}

function containsOnlyIdFields(selections) {
  // id and objectId are always available
  // In this case we avoid making a fetch
  // as the caller doesn't need more info
  const wantsId = selections.indexOf('id') >= 0;
  const wantsObjectId = selections.indexOf('objectId') >= 0;
  return wantsId && wantsObjectId && selections.length == 2 || wantsId && selections.length == 1 || wantsObjectId && selections.length == 1;
}

function handleFileUpload(config, auth, className, input, schema) {
  const objectSchema = schema[className];
  const promises = Object.keys(objectSchema.fields).filter(field => objectSchema.fields[field].type === 'File').reduce((memo, field) => {
    if (input[field]) {
      memo.push({
        fieldName: field,
        contents: input[field]
      });
    }

    return memo;
  }, []).map(({
    fieldName,
    contents: {
      name,
      base64,
      contentType
    }
  }) => {
    return config.filesController.createFile(config, name, new Buffer(base64, 'base64'), contentType).then(({
      url,
      name
    }) => {
      input[fieldName] = {
        url,
        name,
        __type: 'File'
      };
    });
  });
  return Promise.all(promises);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ncmFwaHFsL2V4ZWN1dGUuanMiXSwibmFtZXMiOlsiZ2V0R2xvYmFsbHlVbmlxdWVJZCIsImNsYXNzTmFtZSIsIm9iamVjdElkIiwiYmFzZTY0IiwidHJhbnNmb3JtUmVzdWx0IiwicmVzdWx0IiwiQXJyYXkiLCJpc0FycmF5IiwibWFwIiwicmVzIiwiaWQiLCJBQ0wiLCJPYmplY3QiLCJhc3NpZ24iLCJ0b0dyYXBoUUxSZXN1bHQiLCJyZXN0UmVzdWx0IiwicmVzdWx0cyIsImxlbmd0aCIsInRyYW5zZm9ybVF1ZXJ5Q29uc3RyYWludCIsImtleSIsInZhbHVlIiwibGF0aXR1ZGUiLCJwb2ludCIsImxvbmdpdHVkZSIsInRyYW5zZm9ybVF1ZXJ5IiwicXVlcnkiLCJrZXlzIiwiZm9yRWFjaCIsInF1ZXJ5S2V5IiwiY29uc3RyYWludEtleSIsImNvbnN0cmFpbnQiLCJzdHJpbmciLCJCdWZmZXIiLCJ0b1N0cmluZyIsInBhcnNlSUQiLCJiYXNlNjRTdHJpbmciLCJjb21wb25lbnRzIiwic3BsaXQiLCJFcnJvciIsImNvbm5lY3Rpb25SZXN1bHRzQXJyYXkiLCJhcmdzIiwiZGVmYXVsdFBhZ2VTaXplIiwicGFnZVNpemUiLCJmaXJzdCIsImxhc3QiLCJub2RlcyIsImVkZ2VzIiwibm9kZSIsImN1cnNvciIsImNyZWF0ZWRBdCIsInBhZ2VJbmZvIiwiaGFzUHJldmlvdXNQYWdlIiwiYWZ0ZXIiLCJoYXNOZXh0UGFnZSIsImJlZm9yZSIsInBhcnNlQXJndW1lbnRzIiwib3B0aW9ucyIsInByb3RvdHlwZSIsImhhc093blByb3BlcnR5IiwiY2FsbCIsImxpbWl0Iiwib3JkZXIiLCIkZ3QiLCJEYXRlIiwiJGx0IiwicmVkaXJlY3RDbGFzc05hbWVGb3JLZXkiLCJxdWVyeUFkZGl0aW9ucyIsInJ1bkZpbmQiLCJjb250ZXh0IiwiaW5mbyIsInNjaGVtYSIsInJlc3RRdWVyeSIsIndoZXJlIiwicmVzdCIsImZpbmQiLCJjb25maWciLCJhdXRoIiwidGhlbiIsInJ1bkdldCIsImdldCIsInJlc29sdmVQb2ludGVyIiwidGFyZ2V0Q2xhc3MiLCJvYmplY3QiLCJzZWxlY3Rpb25zIiwiZmllbGROb2RlcyIsInNlbGVjdGlvblNldCIsImZpZWxkIiwibmFtZSIsImNvbnRhaW5zT25seUlkRmllbGRzIiwid2FudHNJZCIsImluZGV4T2YiLCJ3YW50c09iamVjdElkIiwiaGFuZGxlRmlsZVVwbG9hZCIsImlucHV0Iiwib2JqZWN0U2NoZW1hIiwicHJvbWlzZXMiLCJmaWVsZHMiLCJmaWx0ZXIiLCJ0eXBlIiwicmVkdWNlIiwibWVtbyIsInB1c2giLCJmaWVsZE5hbWUiLCJjb250ZW50cyIsImNvbnRlbnRUeXBlIiwiZmlsZXNDb250cm9sbGVyIiwiY3JlYXRlRmlsZSIsInVybCIsIl9fdHlwZSIsIlByb21pc2UiLCJhbGwiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUE7Ozs7QUFFTyxTQUFTQSxtQkFBVCxDQUE2QkMsU0FBN0IsRUFBd0NDLFFBQXhDLEVBQWtEO0FBQ3ZELFNBQU9DLE1BQU0sQ0FBRSxHQUFFRixTQUFVLEtBQUlDLFFBQVMsRUFBM0IsQ0FBYjtBQUNEOztBQUVNLFNBQVNFLGVBQVQsQ0FBeUJILFNBQXpCLEVBQW9DSSxNQUFwQyxFQUE0QztBQUNqRCxNQUFJQyxLQUFLLENBQUNDLE9BQU4sQ0FBY0YsTUFBZCxDQUFKLEVBQTJCO0FBQ3pCLFdBQU9BLE1BQU0sQ0FBQ0csR0FBUCxDQUFXQyxHQUFHLElBQUlMLGVBQWUsQ0FBQ0gsU0FBRCxFQUFZUSxHQUFaLENBQWpDLENBQVA7QUFDRDs7QUFDRCxNQUFJSixNQUFNLENBQUNILFFBQVgsRUFBcUI7QUFDbkI7QUFDQUcsSUFBQUEsTUFBTSxDQUFDSyxFQUFQLEdBQVlWLG1CQUFtQixDQUFDQyxTQUFELEVBQVlJLE1BQU0sQ0FBQ0gsUUFBbkIsQ0FBL0I7QUFDRDs7QUFDRCxNQUFJRyxNQUFNLENBQUNNLEdBQVgsRUFBZ0I7QUFDZE4sSUFBQUEs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bUI7QUFDdkJNLE1BQUFBLEtBQUssQ0FBQ1MsU0FBRCxDQUFMLEdBQW1CO0FBQUVLLFFBQUFBLEdBQUY7QUFBT3BCLFFBQUFBLElBQVA7QUFBYXFCLFFBQUFBLE1BQU0sRUFBRTtBQUFyQixPQUFuQjtBQUNELEtBSkksQ0FBUDtBQUtELEdBZGMsQ0FBakI7QUFlQSxTQUFPQyxPQUFPLENBQUNDLEdBQVIsQ0FBWWYsUUFBWixDQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcmVzdCBmcm9tICcuLi9yZXN0JztcbmltcG9ydCB7IHRvR3JhcGhRTEFDTCB9IGZyb20gJy4vdHlwZXMvQUNMJztcbmV4cG9ydCB7IHJlc3QgfTtcbmltcG9ydCB7IENvbmZpZyB9IGZyb20gJy4uL0NvbmZpZyc7XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRHbG9iYWxseVVuaXF1ZUlkKGNsYXNzTmFtZSwgb2JqZWN0SWQpIHtcbiAgcmV0dXJuIGJhc2U2NChgJHtjbGFzc05hbWV9Ojoke29iamVjdElkfWApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdHJhbnNmb3JtUmVzdWx0KGNsYXNzTmFtZSwgcmVzdWx0KSB7XG4gIGlmIChBcnJheS5pc0FycmF5KHJlc3VsdCkpIHtcbiAgICByZXR1cm4gcmVzdWx0Lm1hcChyZXMgPT4gdHJhbnNmb3JtUmVzdWx0KGNsYXNzTmFtZSwgcmVzKSk7XG4gIH1cbiAgaWYgKHJlc3VsdC5vYmplY3RJZCkge1xuICAgIC8vIE1ha2UgYSB1bmlxdWUgaWRlbnRpZmllciBmb3IgcmVsYXlcbiAgICByZXN1bHQuaWQgPSBnZXRHbG9iYWxseVVuaXF1ZUlkKGNsYXNzTmFtZSwgcmVzdWx0Lm9iamVjdElkKTtcbiAgfVxuICBpZiAocmVzdWx0LkFDTCkge1xuICAgIHJlc3VsdC5BQ0wgPSB0b0dyYXBoUUxBQ0wocmVzdWx0LkFDTCk7XG4gIH1cbiAgcmV0dXJuIE9iamVjdC5hc3NpZ24oeyBjbGFzc05hbWUgfSwgcmVzdWx0KTtcbn1cblxuZnVuY3Rpb24gdG9HcmFwaFFMUmVzdWx0KGNsYXNzTmFtZSkge1xuICByZXR1cm4gcmVzdFJlc3VsdCA9PiB7XG4gICAgY29uc3QgcmVzdWx0cyA9IHJlc3RSZXN1bHQucmVzdWx0cztcbiAgICBpZiAocmVzdWx0cy5sZW5ndGggPT0gMCkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICByZXR1cm4gdHJhbnNmb3JtUmVzdWx0KGNsYXNzTmFtZSwgcmVzdWx0cyk7XG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0cmFuc2Zvcm1RdWVyeUNvbnN0cmFpbnQoa2V5LCB2YWx1ZSkge1xuICBpZiAoa2V5ID09PSAnbmVhclNwaGVyZScpIHtcbiAgICB2YWx1ZSA9IHtcbiAgICAgIGxhdGl0dWRlOiB2YWx1ZS5wb2ludC5sYXRpdHVkZSxcbiAgICAgIGxvbmdpdHVkZTogdmFsdWUucG9pbnQubG9uZ2l0dWRlLFxuICAgIH07XG4gIH1cbiAgcmV0dXJuIHtcbiAgICBrZXk6IGAkJHtrZXl9YCxcbiAgICB2YWx1ZSxcbiAgfTtcbn1cblxuZnVuY3Rpb24gdHJhbnNmb3JtUXVlcnkocXVlcnkpIHtcbiAgT2JqZWN0LmtleXMocXVlcnkpLmZvckVhY2gocXVlcnlLZXkgPT4ge1xuICAgIE9iamVjdC5rZXlzKHF1ZXJ5W3F1ZXJ5S2V5XSkuZm9yRWFjaChjb25zdHJhaW50S2V5ID0+IHtcbiAgICAgIGNvbnN0IGNvbnN0cmFpbnQgPSBxdWVyeVtxdWVyeUtleV1bY29uc3RyYWludEtleV07XG4gICAgICBkZWxldGUgcXVlcnlbcXVlcnlLZXldW2NvbnN0cmFpbnRLZXldO1xuICAgICAgY29uc3QgeyBrZXksIHZhbHVlIH0gPSB0cmFuc2Zvcm1RdWVyeUNvbnN0cmFpbnQoXG4gICAgICAgIGNvbnN0cmFpbnRLZXksXG4gICAgICAgIGNvbnN0cmFpbnRcbiAgICAgICk7XG4gICAgICBxdWVyeVtxdWVyeUtleV1ba2V5XSA9IHZhbHVlO1xuICAgIH0pO1xuICB9KTtcbiAgcmV0dXJuIHF1ZXJ5O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYmFzZTY0KHN0cmluZykge1xuICByZXR1cm4gbmV3IEJ1ZmZlcihzdHJpbmcpLnRvU3RyaW5nKCdiYXNlNjQnKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlSUQoYmFzZTY0U3RyaW5nKSB7XG4gIC8vIEdldCB0aGUgc2VsZWN0aW9uc1xuICBjb25zdCBjb21wb25lbnRzID0gbmV3IEJ1ZmZlcihiYXNlNjRTdHJpbmcsICdiYXNlNjQnKVxuICAgIC50b1N0cmluZygndXRmOCcpXG4gICAgLnNwbGl0KCc6OicpO1xuICBpZiAoY29tcG9uZW50cy5sZW5ndGggIT0gMikge1xuICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBJRCcpO1xuICB9XG4gIHJldHVybiB7XG4gICAgY2xhc3NOYW1lOiBjb21wb25lbnRzWzBdLFxuICAgIG9iamVjdElkOiBjb21wb25lbnRzWzFdLFxuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY29ubmVjdGlvblJlc3VsdHNBcnJheShyZXN1bHRzLCBhcmdzLCBkZWZhdWx0UGFnZVNpemUpIHtcbiAgY29uc3QgcGFnZVNpemUgPSBhcmdzLmZpcnN0IHx8IGFyZ3MubGFzdCB8fCBkZWZhdWx0UGFnZVNpemU7XG4gIHJldHVybiB7XG4gICAgbm9kZXM6ICgpID0+IHJlc3VsdHMsXG4gICAgZWRnZXM6ICgpID0+XG4gICAgICByZXN1bHRzLm1hcChub2RlID0+IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBjdXJzb3I6IGJhc2U2NChub2RlLmNyZWF0ZWRBdCksXG4gICAgICAgICAgbm9kZSxcbiAgICAgICAgfTtcbiAgICAgIH0pLFxuICAgIHBhZ2VJbmZvOiAoKSA9PiB7XG4gICAgICBjb25zdCBoYXNQcmV2aW91c1BhZ2UgPSAoKSA9PiB7XG4gICAgICAgIGlmIChhcmdzLmxhc3QpIHtcbiAgICAgICAgICByZXR1cm4gcmVzdWx0cy5sZW5ndGggPT09IHBhZ2VTaXplO1xuICAgICAgICB9XG4gICAgICAgIGlmIChhcmdzLmFmdGVyKSB7XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfTtcbiAgICAgIGNvbnN0IGhhc05leHRQYWdlID0gKCkgPT4ge1xuICAgICAgICBpZiAoYXJncy5maXJzdCkge1xuICAgICAgICAgIHJldHVybiByZXN1bHRzLmxlbmd0aCA9PT0gcGFnZVNpemU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGFyZ3MuYmVmb3JlKSB7XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGhhc05leHRQYWdlLFxuICAgICAgICBoYXNQcmV2aW91c1BhZ2UsXG4gICAgICB9O1xuICAgIH0sXG4gIH07XG59XG5cbmZ1bmN0aW9uIHBhcnNlQXJndW1lbnRzKGFyZ3MpIHtcbiAgY29uc3QgcXVlcnkgPSB7fTtcbiAgY29uc3Qgb3B0aW9ucyA9IHt9O1xuICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGFyZ3MsICdmaXJzdCcpKSB7XG4gICAgb3B0aW9ucy5saW1pdCA9IGFyZ3MuZmlyc3Q7XG4gICAgb3B0aW9ucy5vcmRlciA9ICdjcmVhdGVkQXQnO1xuICB9XG4gIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYXJncywgJ2xhc3QnKSkge1xuICAgIG9wdGlvbnMubGltaXQgPSBhcmdzLmxhc3Q7XG4gICAgb3B0aW9ucy5vcmRlciA9ICctY3JlYXRlZEF0JztcbiAgfVxuICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGFyZ3MsICdhZnRlcicpKSB7XG4gICAgcXVlcnkuY3JlYXRlZEF0ID0ge1xuICAgICAgJGd0OiBuZXcgRGF0ZShuZXcgQnVmZmVyKGFyZ3MuYWZ0ZXIsICdiYXNlNjQnKS50b1N0cmluZygndXRmOCcpKSxcbiAgICB9O1xuICB9XG4gIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYXJncywgJ2JlZm9yZScpKSB7XG4gICAgcXVlcnkuY3JlYXRlZEF0ID0ge1xuICAgICAgJGx0OiBuZXcgRGF0ZShuZXcgQnVmZmVyKGFyZ3MuYmVmb3JlLCAnYmFzZTY0JykudG9TdHJpbmcoJ3V0ZjgnKSksXG4gICAgfTtcbiAgfVxuICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGFyZ3MsICdyZWRpcmVjdENsYXNzTmFtZUZvcktleScpKSB7XG4gICAgb3B0aW9ucy5yZWRpcmVjdENsYXNzTmFtZUZvcktleSA9IGFyZ3MucmVkaXJlY3RDbGFzc05hbWVGb3JLZXk7XG4gIH1cbiAgcmV0dXJuIHsgb3B0aW9ucywgcXVlcnlBZGRpdGlvbnM6IHF1ZXJ5IH07XG59XG5cbnR5cGUgQ29udGV4dCA9IHsgYXV0aDogYW55LCBjb25maWc6IENvbmZpZyB9O1xuXG4vLyBSdW5zIGEgZmluZCBhZ2FpbnN0IHRoZSByZXN0IEFQSVxuZXhwb3J0IGZ1bmN0aW9uIHJ1bkZpbmQoXG4gIGNvbnRleHQ6IENvbmZpZyxcbiAgaW5mbyxcbiAgY2xhc3NOYW1lLFxuICBhcmdzLFxuICBzY2hlbWEsXG4gIHJlc3RRdWVyeVxuKSB7XG4gIGNvbnN0IHF1ZXJ5ID0ge307XG4gIGlmIChhcmdzLndoZXJlKSB7XG4gICAgT2JqZWN0LmFzc2lnbihxdWVyeSwgYXJncy53aGVyZSk7XG4gIH1cbiAgdHJhbnNmb3JtUXVlcnkocXVlcnksIHNjaGVtYSk7XG4gIGlmIChyZXN0UXVlcnkpIHtcbiAgICBPYmplY3QuYXNzaWduKHF1ZXJ5LCByZXN0UXVlcnkpO1xuICB9XG5cbiAgY29uc3QgeyBvcHRpb25zLCBxdWVyeUFkZGl0aW9ucyB9ID0gcGFyc2VBcmd1bWVudHMoYXJncyk7XG4gIE9iamVjdC5hc3NpZ24ocXVlcnksIHF1ZXJ5QWRkaXRpb25zKTtcblxuICByZXR1cm4gcmVzdFxuICAgIC5maW5kKGNvbnRleHQuY29uZmlnLCBjb250ZXh0LmF1dGgsIGNsYXNzTmFtZSwgcXVlcnksIG9wdGlvbnMpXG4gICAgLnRoZW4odG9HcmFwaFFMUmVzdWx0KGNsYXNzTmFtZSkpO1xufVxuXG4vLyBydW5zIGEgZ2V0IGFnYWluc3QgdGhlIHJlc3QgQVBJXG5leHBvcnQgZnVuY3Rpb24gcnVuR2V0KFxuICBjb250ZXh0OiBDb250ZXh0LFxuICBpbmZvLFxuICBjbGFzc05hbWU6IHN0cmluZyxcbiAgb2JqZWN0SWQ6IHN0cmluZ1xuKSB7XG4gIHJldHVybiByZXN0XG4gICAgLmdldChjb250ZXh0LmNvbmZpZywgY29udGV4dC5hdXRoLCBjbGFzc05hbWUsIG9iamVjdElkLCB7fSlcbiAgICAudGhlbih0b0dyYXBoUUxSZXN1bHQoY2xhc3NOYW1lKSlcbiAgICAudGhlbihyZXN1bHRzID0+IHJlc3VsdHNbMF0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVzb2x2ZVBvaW50ZXIodGFyZ2V0Q2xhc3MsIG9iamVjdCwgc2NoZW1hLCBjb250ZXh0LCBpbmZvKSB7XG4gIGNvbnN0IHNlbGVjdGlvbnMgPSBpbmZvLmZpZWxkTm9kZXNbMF0uc2VsZWN0aW9uU2V0LnNlbGVjdGlvbnMubWFwKGZpZWxkID0+IHtcbiAgICByZXR1cm4gZmllbGQubmFtZS52YWx1ZTtcbiAgfSk7XG4gIGlmIChjb250YWluc09ubHlJZEZpZWxkcyhzZWxlY3Rpb25zKSkge1xuICAgIHJldHVybiB0cmFuc2Zvcm1SZXN1bHQodGFyZ2V0Q2xhc3MsIG9iamVjdCwgc2NoZW1hLCB7IGNvbnRleHQsIGluZm8gfSk7XG4gIH1cblxuICByZXR1cm4gcnVuR2V0KGNvbnRleHQsIGluZm8sIG9iamVjdC5jbGFzc05hbWUsIG9iamVjdC5vYmplY3RJZCwgc2NoZW1hKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvbnRhaW5zT25seUlkRmllbGRzKHNlbGVjdGlvbnMpIHtcbiAgLy8gaWQgYW5kIG9iamVjdElkIGFyZSBhbHdheXMgYXZhaWxhYmxlXG4gIC8vIEluIHRoaXMgY2FzZSB3ZSBhdm9pZCBtYWtpbmcgYSBmZXRjaFxuICAvLyBhcyB0aGUgY2FsbGVyIGRvZXNuJ3QgbmVlZCBtb3JlIGluZm9cbiAgY29uc3Qgd2FudHNJZCA9IHNlbGVjdGlvbnMuaW5kZXhPZignaWQnKSA+PSAwO1xuICBjb25zdCB3YW50c09iamVjdElkID0gc2VsZWN0aW9ucy5pbmRleE9mKCdvYmplY3RJZCcpID49IDA7XG4gIHJldHVybiAoXG4gICAgKHdhbnRzSWQgJiYgd2FudHNPYmplY3RJZCAmJiBzZWxlY3Rpb25zLmxlbmd0aCA9PSAyKSB8fFxuICAgICh3YW50c0lkICYmIHNlbGVjdGlvbnMubGVuZ3RoID09IDEpIHx8XG4gICAgKHdhbnRzT2JqZWN0SWQgJiYgc2VsZWN0aW9ucy5sZW5ndGggPT0gMSlcbiAgKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGhhbmRsZUZpbGVVcGxvYWQoXG4gIGNvbmZpZzogQ29uZmlnLFxuICBhdXRoLFxuICBjbGFzc05hbWUsXG4gIGlucHV0OiBhbnksXG4gIHNjaGVtYVxuKSB7XG4gIGNvbnN0IG9iamVjdFNjaGVtYSA9IHNjaGVtYVtjbGFzc05hbWVdO1xuICBjb25zdCBwcm9taXNlcyA9IE9iamVjdC5rZXlzKG9iamVjdFNjaGVtYS5maWVsZHMpXG4gICAgLmZpbHRlcihmaWVsZCA9PiBvYmplY3RTY2hlbWEuZmllbGRzW2ZpZWxkXS50eXBlID09PSAnRmlsZScpXG4gICAgLnJlZHVjZSgobWVtbywgZmllbGQpID0+IHtcbiAgICAgIGlmIChpbnB1dFtmaWVsZF0pIHtcbiAgICAgICAgbWVtby5wdXNoKHsgZmllbGROYW1lOiBmaWVsZCwgY29udGVudHM6IGlucHV0W2ZpZWxkXSB9KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBtZW1vO1xuICAgIH0sIFtdKVxuICAgIC5tYXAoKHsgZmllbGROYW1lLCBjb250ZW50czogeyBuYW1lLCBiYXNlNjQsIGNvbnRlbnRUeXBlIH0gfSkgPT4ge1xuICAgICAgcmV0dXJuIGNvbmZpZy5maWxlc0NvbnRyb2xsZXJcbiAgICAgICAgLmNyZWF0ZUZpbGUoY29uZmlnLCBuYW1lLCBuZXcgQnVmZmVyKGJhc2U2NCwgJ2Jhc2U2NCcpLCBjb250ZW50VHlwZSlcbiAgICAgICAgLnRoZW4oKHsgdXJsLCBuYW1lIH0pID0+IHtcbiAgICAgICAgICBpbnB1dFtmaWVsZE5hbWVdID0geyB1cmwsIG5hbWUsIF9fdHlwZTogJ0ZpbGUnIH07XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xufVxuIl19