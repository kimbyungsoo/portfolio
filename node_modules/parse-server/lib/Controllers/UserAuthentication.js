"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.removeHiddenProperties = removeHiddenProperties;
exports.verifyCredentials = verifyCredentials;
exports.logIn = logIn;
exports.logOut = logOut;

var _password = _interopRequireDefault(require("../password"));

var _AccountLockout = _interopRequireDefault(require("../AccountLockout"));

var _Auth = _interopRequireDefault(require("../Auth"));

var _rest = _interopRequireDefault(require("../rest"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const Parse = require('parse/node');

function removeHiddenProperties(obj) {
  for (var key in obj) {
    if (obj.hasOwnProperty(key)) {
      // Regexp comes from Parse.Object.prototype.validate
      if (key !== '__type' && !/^[A-Za-z][0-9A-Za-z_]*$/.test(key)) {
        delete obj[key];
      }
    }
  }
}

async function verifyCredentials({
  username,
  password,
  email
}, config, auth) {
  // TODO: use the right error codes / descriptions.
  if (!username && !email) {
    throw new Parse.Error(Parse.Error.USERNAME_MISSING, 'username/email is required.');
  }

  if (!password) {
    throw new Parse.Error(Parse.Error.PASSWORD_MISSING, 'password is required.');
  }

  if (typeof password !== 'string' || email && typeof email !== 'string' || username && typeof username !== 'string') {
    throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Invalid username/password.');
  }

  let user;
  let isValidPassword = false;
  let query;

  if (email && username) {
    query = {
      email,
      username
    };
  } else if (email) {
    query = {
      email
    };
  } else {
    query = {
      $or: [{
        username
      }, {
        email: username
      }]
    };
  }

  const results = await config.database.find('_User', query);

  if (!results.length) {
    throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Invalid username/password.');
  }

  if (results.length > 1) {
    // corner case where user1 has username == user2 email
    config.loggerController.warn("There is a user which email is the same as another user's username, logging in based on username");
    user = results.filter(user => user.username === username)[0];
  } else {
    user = results[0];
  }

  isValidPassword = await _password.default.compare(password, user.password);
  const accountLockoutPolicy = new _AccountLockout.default(user, config);
  await accountLockoutPolicy.handleLoginAttempt(isValidPassword);

  if (!isValidPassword) {
    throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Invalid username/password.');
  } // Ensure the user isn't locked out
  // A locked out user won't be able to login
  // To lock a user out, just set the ACL to `masterKey` only  ({}).
  // Empty ACL is OK


  if (!auth.isMaster && user.ACL && Object.keys(user.ACL).length == 0) {
    throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Invalid username/password.');
  }

  if (config.verifyUserEmails && config.preventLoginWithUnverifiedEmail && !user.emailVerified) {
    throw new Parse.Error(Parse.Error.EMAIL_NOT_FOUND, 'User email is not verified.');
  }

  delete user.password; // Sometimes the authData still has null on that keys
  // https://github.com/parse-community/parse-server/issues/935

  if (user.authData) {
    Object.keys(user.authData).forEach(provider => {
      if (user.authData[provider] === null) {
        delete user.authData[provider];
      }
    });

    if (Object.keys(user.authData).length == 0) {
      delete user.authData;
    }
  }

  return user;
}

async function logIn({
  username,
  password,
  email
}, config, auth, installationId) {
  const user = await verifyCredentials({
    username,
    password,
    email
  }, config, auth); // handle password expiry policy

  if (config.passwordPolicy && config.passwordPolicy.maxPasswordAge) {
    let changedAt = user._password_changed_at;

    if (!changedAt) {
      // password was created before expiry policy was enabled.
      // simply update _User object so that it will start enforcing from now
      changedAt = new Date();
      config.database.update('_User', {
        username: user.username
      }, {
        _password_changed_at: Parse._encode(changedAt)
      });
    } else {
      // check whether the password has expired
      if (changedAt.__type == 'Date') {
        changedAt = new Date(changedAt.iso);
      } // Calculate the expiry time.


      const expiresAt = new Date(changedAt.getTime() + 86400000 * config.passwordPolicy.maxPasswordAge);
      if (expiresAt < new Date()) // fail of current time is past password expiry time
        throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Your password has expired. Please reset your password.');
    }
  } // Remove hidden properties.


  removeHiddenProperties(user);

  const {
    sessionData,
    createSession
  } = _Auth.default.createSession(config, {
    userId: user.objectId,
    createdWith: {
      action: 'login',
      authProvider: 'password'
    },
    installationId: installationId
  });

  user.sessionToken = sessionData.sessionToken;
  config.filesController.expandFilesInObject(config, user);
  await createSession();
  return user;
}

async function logOut(sessionToken, config, clientSDK) {
  const master = _Auth.default.master(config);

  const records = await _rest.default.find(config, master, '_Session', {
    sessionToken: sessionToken
  }, undefined, clientSDK);

  if (records.results && records.results.length) {
    await _rest.default.del(config, master, '_Session', records.results[0].objectId);
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Db250cm9sbGVycy9Vc2VyQXV0aGVudGljYXRpb24uanMiXSwibmFtZXMiOlsiUGFyc2UiLCJyZXF1aXJlIiwicmVtb3ZlSGlkZGVuUHJvcGVydGllcyIsIm9iaiIsImtleSIsImhhc093blByb3BlcnR5IiwidGVzdCIsInZlcmlmeUNyZWRlbnRpYWxzIiwidXNlcm5hbWUiLCJwYXNzd29yZCIsImVtYWlsIiwiY29uZmlnIiwiYXV0aCIsIkVycm9yIiwiVVNFUk5BTUVfTUlTU0lORyIsIlBBU1NXT1JEX01JU1NJTkciLCJPQkpFQ1RfTk9UX0ZPVU5EIiwidXNlciIsImlzVmFsaWRQYXNzd29yZCIsInF1ZXJ5IiwiJG9yIiwicmVzdWx0cyIsImRhdGFiYXNlIiwiZmluZCIsImxlbmd0aCIsImxvZ2dlckNvbnRyb2xsZXIiLCJ3YXJuIiwiZmlsdGVyIiwicGFzc3dvcmRDcnlwdG8iLCJjb21wYXJlIiwiYWNjb3VudExvY2tvdXRQb2xpY3kiLCJBY2NvdW50TG9ja291dCIsImhhbmRsZUxvZ2luQXR0ZW1wdCIsImlzTWFzdGVyIiwiQUNMIiwiT2JqZWN0Iiwia2V5cyIsInZlcmlmeVVzZXJFbWFpbHMiLCJwcmV2ZW50TG9naW5XaXRoVW52ZXJpZmllZEVtYWlsIiwiZW1haWxWZXJpZmllZCIsIkVNQUlMX05PVF9GT1VORCIsImF1dGhEYXRhIiwiZm9yRWFjaCIsInByb3ZpZGVyIiwibG9nSW4iLCJpbnN0YWxsYXRpb25JZCIsInBhc3N3b3JkUG9saWN5IiwibWF4UGFzc3dvcmRBZ2UiLCJjaGFuZ2VkQXQiLCJfcGFzc3dvcmRfY2hhbmdlZF9hdCIsIkRhdGUiLCJ1cGRhdGUiLCJfZW5jb2RlIiwiX190eXBlIiwiaXNvIiwiZXhwaXJlc0F0IiwiZ2V0VGltZSIsInNlc3Npb25EYXRhIiwiY3JlYXRlU2Vzc2lvbiIsIkF1dGgiLCJ1c2VySWQiLCJvYmplY3RJZCIsImNyZWF0ZWRXaXRoIiwiYWN0aW9uIiwiYXV0aFByb3ZpZGVyIiwic2Vzc2lvblRva2VuIiwiZmlsZXNDb250cm9sbGVyIiwiZXhwYW5kRmlsZXNJbk9iamVjdCIsImxvZ091dCIsImNsaWVudFNESyIsIm1hc3RlciIsInJlY29yZHMiLCJyZXN0IiwidW5kZWZpbmVkIiwiZGVsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFKQSxNQUFNQSxLQUFLLEdBQUdDLE9BQU8sQ0FBQyxZQUFELENBQXJCOztBQU1PLFNBQVNDLHNCQUFULENBQWdDQyxHQUFoQyxFQUFxQztBQUMxQyxPQUFLLElBQUlDLEdBQVQsSUFBZ0JELEdBQWhCLEVBQXFCO0FBQ25CLFFBQUlBLEdBQUcsQ0FBQ0UsY0FBSixDQUFtQkQsR0FBbkIsQ0FBSixFQUE2QjtBQUMzQjtBQUNBLFVBQUlBLEdBQUcsS0FBSyxRQUFSLElBQW9CLENBQUMsMEJBQTBCRSxJQUExQixDQUErQkYsR0FBL0IsQ0FBekIsRUFBOEQ7QUFDNUQsZUFBT0QsR0FBRyxDQUFDQyxHQUFELENBQVY7QUFDRDtBQUNGO0FBQ0Y7QUFDRjs7QUFFTSxlQUFlRyxpQkFBZixDQUNMO0FBQUVDLEVBQUFBLFFBQUY7QUFBWUMsRUFBQUEsUUFBWjtBQUFzQkMsRUFBQUE7QUFBdEIsQ0FESyxFQUVMQyxNQUZLLEVBR0xDLElBSEssRUFJTDtBQUNBO0FBQ0EsTUFBSSxDQUFDSixRQUFELElBQWEsQ0FBQ0UsS0FBbEIsRUFBeUI7QUFDdkIsVUFBTSxJQUFJVixLQUFLLENBQUNhLEtBQVYsQ0FDSmIsS0FBSyxDQUFDYSxLQUFOLENBQVlDLGdCQURSLEVBRUosNkJBRkksQ0FBTjtBQUlEOztBQUNELE1BQUksQ0FBQ0wsUUFBTCxFQUFlO0FBQ2IsVUFBTSxJQUFJVCxLQUFLLENBQUNhLEtBQVYsQ0FDSmIsS0FBSyxDQUFDYSxLQUFOLENBQVlFLGdCQURSLEVBRUosdUJBRkksQ0FBTjtBQUlEOztBQUNELE1BQ0UsT0FBT04sUUFBUCxLQUFvQixRQUFwQixJQUNDQyxLQUFLLElBQUksT0FBT0EsS0FBUCxLQUFpQixRQUQz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TUFBM0MsRUFBbURNLElBQW5EO0FBRUEsUUFBTXlDLGFBQWEsRUFBbkI7QUFDQSxTQUFPekMsSUFBUDtBQUNEOztBQUVNLGVBQWVtRCxNQUFmLENBQXNCSCxZQUF0QixFQUFvQ3RELE1BQXBDLEVBQTRDMEQsU0FBNUMsRUFBdUQ7QUFDNUQsUUFBTUMsTUFBTSxHQUFHWCxjQUFLVyxNQUFMLENBQVkzRCxNQUFaLENBQWY7O0FBQ0EsUUFBTTRELE9BQU8sR0FBRyxNQUFNQyxjQUFLakQsSUFBTCxDQUNwQlosTUFEb0IsRUFFcEIyRCxNQUZvQixFQUdwQixVQUhvQixFQUlwQjtBQUFFTCxJQUFBQSxZQUFZLEVBQUVBO0FBQWhCLEdBSm9CLEVBS3BCUSxTQUxvQixFQU1wQkosU0FOb0IsQ0FBdEI7O0FBUUEsTUFBSUUsT0FBTyxDQUFDbEQsT0FBUixJQUFtQmtELE9BQU8sQ0FBQ2xELE9BQVIsQ0FBZ0JHLE1BQXZDLEVBQStDO0FBQzdDLFVBQU1nRCxjQUFLRSxHQUFMLENBQVMvRCxNQUFULEVBQWlCMkQsTUFBakIsRUFBeUIsVUFBekIsRUFBcUNDLE9BQU8sQ0FBQ2xELE9BQVIsQ0FBZ0IsQ0FBaEIsRUFBbUJ3QyxRQUF4RCxDQUFOO0FBQ0Q7QUFDRiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IFBhcnNlID0gcmVxdWlyZSgncGFyc2Uvbm9kZScpO1xuaW1wb3J0IHBhc3N3b3JkQ3J5cHRvIGZyb20gJy4uL3Bhc3N3b3JkJztcbmltcG9ydCBBY2NvdW50TG9ja291dCBmcm9tICcuLi9BY2NvdW50TG9ja291dCc7XG5pbXBvcnQgQXV0aCBmcm9tICcuLi9BdXRoJztcbmltcG9ydCByZXN0IGZyb20gJy4uL3Jlc3QnO1xuXG5leHBvcnQgZnVuY3Rpb24gcmVtb3ZlSGlkZGVuUHJvcGVydGllcyhvYmopIHtcbiAgZm9yICh2YXIga2V5IGluIG9iaikge1xuICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgLy8gUmVnZXhwIGNvbWVzIGZyb20gUGFyc2UuT2JqZWN0LnByb3RvdHlwZS52YWxpZGF0ZVxuICAgICAgaWYgKGtleSAhPT0gJ19fdHlwZScgJiYgIS9eW0EtWmEtel1bMC05QS1aYS16X10qJC8udGVzdChrZXkpKSB7XG4gICAgICAgIGRlbGV0ZSBvYmpba2V5XTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHZlcmlmeUNyZWRlbnRpYWxzKFxuICB7IHVzZXJuYW1lLCBwYXNzd29yZCwgZW1haWwgfSxcbiAgY29uZmlnLFxuICBhdXRoXG4pIHtcbiAgLy8gVE9ETzogdXNlIHRoZSByaWdodCBlcnJvciBjb2RlcyAvIGRlc2NyaXB0aW9ucy5cbiAgaWYgKCF1c2VybmFtZSAmJiAhZW1haWwpIHtcbiAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICBQYXJzZS5FcnJvci5VU0VSTkFNRV9NSVNTSU5HLFxuICAgICAgJ3VzZXJuYW1lL2VtYWlsIGlzIHJlcXVpcmVkLidcbiAgICApO1xuICB9XG4gIGlmICghcGFzc3dvcmQpIHtcbiAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICBQYXJzZS5FcnJvci5QQVNTV09SRF9NSVNTSU5HLFxuICAgICAgJ3Bhc3N3b3JkIGlzIHJlcXVpcmVkLidcbiAgICApO1xuICB9XG4gIGlmIChcbiAgICB0eXBlb2YgcGFzc3dvcmQgIT09ICdzdHJpbmcnIHx8XG4gICAgKGVtYWlsICYmIHR5cGVvZiBlbWFpbCAhPT0gJ3N0cmluZycpIHx8XG4gICAgKHVzZXJuYW1lICYmIHR5cGVvZiB1c2VybmFtZSAhPT0gJ3N0cmluZycpXG4gICkge1xuICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihcbiAgICAgIFBhcnNlLkVycm9yLk9CSkVDVF9OT1RfRk9VTkQsXG4gICAgICAnSW52YWxpZCB1c2VybmFtZS9wYXNzd29yZC4nXG4gICAgKTtcbiAgfVxuXG4gIGxldCB1c2VyO1xuICBsZXQgaXNWYWxpZFBhc3N3b3JkID0gZmFsc2U7XG4gIGxldCBxdWVyeTtcbiAgaWYgKGVtYWlsICYmIHVzZXJuYW1lKSB7XG4gICAgcXVlcnkgPSB7IGVtYWlsLCB1c2VybmFtZSB9O1xuICB9IGVsc2UgaWYgKGVtYWlsKSB7XG4gICAgcXVlcnkgPSB7IGVtYWlsIH07XG4gIH0gZWxzZSB7XG4gICAgcXVlcnkgPSB7ICRvcjogW3sgdXNlcm5hbWUgfSwgeyBlbWFpbDogdXNlcm5hbWUgfV0gfTtcbiAgfVxuICBjb25zdCByZXN1bHRzID0gYXdhaXQgY29uZmlnLmRhdGFiYXNlLmZpbmQoJ19Vc2VyJywgcXVlcnkpO1xuICBpZiAoIXJlc3VsdHMubGVuZ3RoKSB7XG4gICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgUGFyc2UuRXJyb3IuT0JKRUNUX05PVF9GT1VORCxcbiAgICAgICdJbnZhbGlkIHVzZXJuYW1lL3Bhc3N3b3JkLidcbiAgICApO1xuICB9XG5cbiAgaWYgKHJlc3VsdHMubGVuZ3RoID4gMSkge1xuICAgIC8vIGNvcm5lciBjYXNlIHdoZXJlIHVzZXIxIGhhcyB1c2VybmFtZSA9PSB1c2VyMiBlbWFpbFxuICAgIGNvbmZpZy5sb2dnZXJDb250cm9sbGVyLndhcm4oXG4gICAgICBcIlRoZXJlIGlzIGEgdXNlciB3aGljaCBlbWFpbCBpcyB0aGUgc2FtZSBhcyBhbm90aGVyIHVzZXIncyB1c2VybmFtZSwgbG9nZ2luZyBpbiBiYXNlZCBvbiB1c2VybmFtZVwiXG4gICAgKTtcbiAgICB1c2VyID0gcmVzdWx0cy5maWx0ZXIodXNlciA9PiB1c2VyLnVzZXJuYW1lID09PSB1c2VybmFtZSlbMF07XG4gIH0gZWxzZSB7XG4gICAgdXNlciA9IHJlc3VsdHNbMF07XG4gIH1cblxuICBpc1ZhbGlkUGFzc3dvcmQgPSBhd2FpdCBwYXNzd29yZENyeXB0by5jb21wYXJlKHBhc3N3b3JkLCB1c2VyLnBhc3N3b3JkKTtcbiAgY29uc3QgYWNjb3VudExvY2tvdXRQb2xpY3kgPSBuZXcgQWNjb3VudExvY2tvdXQodXNlciwgY29uZmlnKTtcbiAgYXdhaXQgYWNjb3VudExvY2tvdXRQb2xpY3kuaGFuZGxlTG9naW5BdHRlbXB0KGlzVmFsaWRQYXNzd29yZCk7XG4gIGlmICghaXNWYWxpZFBhc3N3b3JkKSB7XG4gICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgUGFyc2UuRXJyb3IuT0JKRUNUX05PVF9GT1VORCxcbiAgICAgICdJbnZhbGlkIHVzZXJuYW1lL3Bhc3N3b3JkLidcbiAgICApO1xuICB9XG4gIC8vIEVuc3VyZSB0aGUgdXNlciBpc24ndCBsb2NrZWQgb3V0XG4gIC8vIEEgbG9ja2VkIG91dCB1c2VyIHdvbid0IGJlIGFibGUgdG8gbG9naW5cbiAgLy8gVG8gbG9jayBhIHVzZXIgb3V0LCBqdXN0IHNldCB0aGUgQUNMIHRvIGBtYXN0ZXJLZXlgIG9ubHkgICh7fSkuXG4gIC8vIEVtcHR5IEFDTCBpcyBPS1xuICBpZiAoIWF1dGguaXNNYXN0ZXIgJiYgdXNlci5BQ0wgJiYgT2JqZWN0LmtleXModXNlci5BQ0wpLmxlbmd0aCA9PSAwKSB7XG4gICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgUGFyc2UuRXJyb3IuT0JKRUNUX05PVF9GT1VORCxcbiAgICAgICdJbnZhbGlkIHVzZXJuYW1lL3Bhc3N3b3JkLidcbiAgICApO1xuICB9XG4gIGlmIChcbiAgICBjb25maWcudmVyaWZ5VXNlckVtYWlscyAmJlxuICAgIGNvbmZpZy5wcmV2ZW50TG9naW5XaXRoVW52ZXJpZmllZEVtYWlsICYmXG4gICAgIXVzZXIuZW1haWxWZXJpZmllZFxuICApIHtcbiAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICBQYXJzZS5FcnJvci5FTUFJTF9OT1RfRk9VTkQsXG4gICAgICAnVXNlciBlbWFpbCBpcyBub3QgdmVyaWZpZWQuJ1xuICAgICk7XG4gIH1cblxuICBkZWxldGUgdXNlci5wYXNzd29yZDtcblxuICAvLyBTb21ldGltZXMgdGhlIGF1dGhEYXRhIHN0aWxsIGhhcyBudWxsIG9uIHRoYXQga2V5c1xuICAvLyBodHRwczovL2dpdGh1Yi5jb20vcGFyc2UtY29tbXVuaXR5L3BhcnNlLXNlcnZlci9pc3N1ZXMvOTM1XG4gIGlmICh1c2VyLmF1dGhEYXRhKSB7XG4gICAgT2JqZWN0LmtleXModXNlci5hdXRoRGF0YSkuZm9yRWFjaChwcm92aWRlciA9PiB7XG4gICAgICBpZiAodXNlci5hdXRoRGF0YVtwcm92aWRlcl0gPT09IG51bGwpIHtcbiAgICAgICAgZGVsZXRlIHVzZXIuYXV0aERhdGFbcHJvdmlkZXJdO1xuICAgICAgfVxuICAgIH0pO1xuICAgIGlmIChPYmplY3Qua2V5cyh1c2VyLmF1dGhEYXRhKS5sZW5ndGggPT0gMCkge1xuICAgICAgZGVsZXRlIHVzZXIuYXV0aERhdGE7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHVzZXI7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsb2dJbihcbiAgeyB1c2VybmFtZSwgcGFzc3dvcmQsIGVtYWlsIH0sXG4gIGNvbmZpZyxcbiAgYXV0aCxcbiAgaW5zdGFsbGF0aW9uSWRcbikge1xuICBjb25zdCB1c2VyID0gYXdhaXQgdmVyaWZ5Q3JlZGVudGlhbHMoXG4gICAgeyB1c2VybmFtZSwgcGFzc3dvcmQsIGVtYWlsIH0sXG4gICAgY29uZmlnLFxuICAgIGF1dGhcbiAgKTtcbiAgLy8gaGFuZGxlIHBhc3N3b3JkIGV4cGlyeSBwb2xpY3lcbiAgaWYgKGNvbmZpZy5wYXNzd29yZFBvbGljeSAmJiBjb25maWcucGFzc3dvcmRQb2xpY3kubWF4UGFzc3dvcmRBZ2UpIHtcbiAgICBsZXQgY2hhbmdlZEF0ID0gdXNlci5fcGFzc3dvcmRfY2hhbmdlZF9hdDtcblxuICAgIGlmICghY2hhbmdlZEF0KSB7XG4gICAgICAvLyBwYXNzd29yZCB3YXMgY3JlYXRlZCBiZWZvcmUgZXhwaXJ5IHBvbGljeSB3YXMgZW5hYmxlZC5cbiAgICAgIC8vIHNpbXBseSB1cGRhdGUgX1VzZXIgb2JqZWN0IHNvIHRoYXQgaXQgd2lsbCBzdGFydCBlbmZvcmNpbmcgZnJvbSBub3dcbiAgICAgIGNoYW5nZWRBdCA9IG5ldyBEYXRlKCk7XG4gICAgICBjb25maWcuZGF0YWJhc2UudXBkYXRlKFxuICAgICAgICAnX1VzZXInLFxuICAgICAgICB7IHVzZXJuYW1lOiB1c2VyLnVzZXJuYW1lIH0sXG4gICAgICAgIHsgX3Bhc3N3b3JkX2NoYW5nZWRfYXQ6IFBhcnNlLl9lbmNvZGUoY2hhbmdlZEF0KSB9XG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBjaGVjayB3aGV0aGVyIHRoZSBwYXNzd29yZCBoYXMgZXhwaXJlZFxuICAgICAgaWYgKGNoYW5nZWRBdC5fX3R5cGUgPT0gJ0RhdGUnKSB7XG4gICAgICAgIGNoYW5nZWRBdCA9IG5ldyBEYXRlKGNoYW5nZWRBdC5pc28pO1xuICAgICAgfVxuICAgICAgLy8gQ2FsY3VsYXRlIHRoZSBleHBpcnkgdGltZS5cbiAgICAgIGNvbnN0IGV4cGlyZXNBdCA9IG5ldyBEYXRlKFxuICAgICAgICBjaGFuZ2VkQXQuZ2V0VGltZSgpICsgODY0MDAwMDAgKiBjb25maWcucGFzc3dvcmRQb2xpY3kubWF4UGFzc3dvcmRBZ2VcbiAgICAgICk7XG4gICAgICBpZiAoZXhwaXJlc0F0IDwgbmV3IERhdGUoKSlcbiAgICAgICAgLy8gZmFpbCBvZiBjdXJyZW50IHRpbWUgaXMgcGFzdCBwYXNzd29yZCBleHBpcnkgdGltZVxuICAgICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICAgICAgUGFyc2UuRXJyb3IuT0JKRUNUX05PVF9GT1VORCxcbiAgICAgICAgICAnWW91ciBwYXNzd29yZCBoYXMgZXhwaXJlZC4gUGxlYXNlIHJlc2V0IHlvdXIgcGFzc3dvcmQuJ1xuICAgICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8vIFJlbW92ZSBoaWRkZW4gcHJvcGVydGllcy5cbiAgcmVtb3ZlSGlkZGVuUHJvcGVydGllcyh1c2VyKTtcblxuICBjb25zdCB7IHNlc3Npb25EYXRhLCBjcmVhdGVTZXNzaW9uIH0gPSBBdXRoLmNyZWF0ZVNlc3Npb24oY29uZmlnLCB7XG4gICAgdXNlcklkOiB1c2VyLm9iamVjdElkLFxuICAgIGNyZWF0ZWRXaXRoOiB7XG4gICAgICBhY3Rpb246ICdsb2dpbicsXG4gICAgICBhdXRoUHJvdmlkZXI6ICdwYXNzd29yZCcsXG4gICAgfSxcbiAgICBpbnN0YWxsYXRpb25JZDogaW5zdGFsbGF0aW9uSWQsXG4gIH0pO1xuXG4gIHVzZXIuc2Vzc2lvblRva2VuID0gc2Vzc2lvbkRhdGEuc2Vzc2lvblRva2VuO1xuXG4gIGNvbmZpZy5maWxlc0NvbnRyb2xsZXIuZXhwYW5kRmlsZXNJbk9iamVjdChjb25maWcsIHVzZXIpO1xuXG4gIGF3YWl0IGNyZWF0ZVNlc3Npb24oKTtcbiAgcmV0dXJuIHVzZXI7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsb2dPdXQoc2Vzc2lvblRva2VuLCBjb25maWcsIGNsaWVudFNESykge1xuICBjb25zdCBtYXN0ZXIgPSBBdXRoLm1hc3Rlcihjb25maWcpO1xuICBjb25zdCByZWNvcmRzID0gYXdhaXQgcmVzdC5maW5kKFxuICAgIGNvbmZpZyxcbiAgICBtYXN0ZXIsXG4gICAgJ19TZXNzaW9uJyxcbiAgICB7IHNlc3Npb25Ub2tlbjogc2Vzc2lvblRva2VuIH0sXG4gICAgdW5kZWZpbmVkLFxuICAgIGNsaWVudFNES1xuICApO1xuICBpZiAocmVjb3Jkcy5yZXN1bHRzICYmIHJlY29yZHMucmVzdWx0cy5sZW5ndGgpIHtcbiAgICBhd2FpdCByZXN0LmRlbChjb25maWcsIG1hc3RlciwgJ19TZXNzaW9uJywgcmVjb3Jkcy5yZXN1bHRzWzBdLm9iamVjdElkKTtcbiAgfVxufVxuIl19